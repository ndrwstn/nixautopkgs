# nixautopkgs

This flake provides packages that are not yet in nixpkgs, and tracks newer upstream releases.

## OpenCode Packaging Strategy

OpenCode is exposed as both source-build and binary-package variants:

- `opencode-cli-build`: from the upstream OpenCode flake (`anomalyco/opencode`)
- `opencode-cli-bin`: first-party binary packaging in this repo
- `opencode-desktop-build`: from the upstream OpenCode flake (`anomalyco/opencode`)
- `opencode-desktop-bin`: first-party binary packaging in this repo

The public aliases are still:

- `opencode`
- `opencode-desktop`

Alias routing is machine-managed in `packages/opencode-routing.json` on a per-system basis.

## Automatic Routing Policy

For each system and target (`cli`, `desktop`), CI computes routing with this policy:

1. If `*-build` succeeds, route to `build`.
2. Otherwise, if `*-bin` succeeds, route to `bin`.
3. Otherwise, keep the previous route and fail the workflow.

This gives automatic promotion (`bin -> build`) and demotion (`build -> bin`) per architecture.

## Version and Hash Maintenance

OpenCode binary packaging is pinned and deterministic:

- release version is read from `flake.nix` (`inputs.opencode.url`)
- asset metadata is stored in `packages/opencode-assets.json`
- no runtime self-update behavior is used

Release metadata and routing are automation-managed by:

- `.github/workflows/opencode-routing-update.yml` for Renovate OpenCode PRs
- `.github/workflows/opencode-routing-reconcile.yml` on schedule/manual dispatch

`packages/opencode-assets.json` is generated by `./.github/scripts/update-opencode-assets.sh`, which uses release digests from GitHub.

Manual bump flow (if needed):

1. Update `inputs.opencode.url` in `flake.nix`.
2. Run `./.github/scripts/update-opencode-assets.sh --update-lock`.
3. Run matrix checks and refresh `packages/opencode-routing.json`.

## Platform Notes

Published binary assets are wired for:

- `aarch64-darwin`
- `x86_64-darwin`
- `aarch64-linux`
- `x86_64-linux`

Maintainer-tested targets are currently:

- `aarch64-darwin`
- `x86_64-darwin`
- `x86_64-linux`

`aarch64-linux` is best-effort unless explicitly validated by maintainers.

## Routing and Asset Files

- `packages/opencode-assets.json`: version + per-system CLI/Desktop release assets and pinned hashes.
- `packages/opencode-routing.json`: per-system alias routing (`build` or `bin`) for `cli` and `desktop`.

`flake.nix` reads both files directly and resolves aliases from routing state.
