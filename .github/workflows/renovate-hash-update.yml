name: Update GCS Hashes on Renovate PRs

on:
  pull_request:
    branches: [master]
    # This workflow is intentionally scoped to GCS right now.
    # It is the generic hash-refresh pattern for Renovate PRs and can be
    # expanded to additional package paths as more packages need post-update
    # hash regeneration.
    paths:
      - "packages/gcs/default.nix"
      - ".github/workflows/renovate-hash-update.yml"

concurrency:
  group: renovate-hash-update-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  # Keep this job package-specific for now to avoid coupling unrelated package
  # update behavior, but the structure is reusable for other packages.
  update-gcs-hash:
    if: startsWith(github.head_ref, 'update/')
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Update gcs hashes
        run: nix run nixpkgs#nix-update -- --flake --version=skip gcs

      - name: Commit and push changes
        run: |
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No hash changes detected"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/gcs/default.nix
          git commit -m "chore: update gcs hashes"
          git push
