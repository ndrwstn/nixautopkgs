name: Update Nix Hashes on Renovate PRs

on:
  pull_request:
    branches: [master]
    paths:
      - "packages/*.nix"
      - "flake.nix"

jobs:
  update-hashes:
    # Only run on Renovate PRs
    if: startsWith(github.head_ref, 'update/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Detect changed packages
        id: changes
        run: |
          # Get list of changed .nix files
          CHANGED_FILES=$(git diff --name-only origin/master...HEAD)
          echo "Changed files: $CHANGED_FILES"

          # Check for package changes
          PACKAGES=""
          if echo "$CHANGED_FILES" | grep -q "packages/gcs.nix"; then
            PACKAGES="$PACKAGES gcs"
          fi
          if echo "$CHANGED_FILES" | grep -q "packages/openspec.nix"; then
            PACKAGES="$PACKAGES openspec"
          fi

          # Check for flake.nix changes (opencode input)
          FLAKE_CHANGED="false"
          if echo "$CHANGED_FILES" | grep -q "flake.nix"; then
            FLAKE_CHANGED="true"
          fi

          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "flake_changed=$FLAKE_CHANGED" >> $GITHUB_OUTPUT
          echo "Packages to update: $PACKAGES"
          echo "Flake changed: $FLAKE_CHANGED"

      - name: Update package hashes
        if: steps.changes.outputs.packages != ''
        run: |
          for pkg in ${{ steps.changes.outputs.packages }}; do
            echo "Updating hashes for $pkg..."
            nix run nixpkgs#nix-update -- --flake --version=skip "$pkg" || true
          done

      - name: Update flake.lock for opencode
        if: steps.changes.outputs.flake_changed == 'true'
        run: |
          echo "Updating flake.lock for opencode input..."
          nix flake update opencode

      - name: Check for changes
        id: git-check
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.git-check.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: update nix hashes"
          git push
