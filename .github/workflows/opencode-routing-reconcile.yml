name: Reconcile OpenCode Routing

on:
  schedule:
    - cron: "17 */6 * * *"
  workflow_dispatch:

concurrency:
  group: opencode-routing-reconcile
  cancel-in-progress: true

jobs:
  build-matrix:
    strategy:
      fail-fast: false
      matrix:
        include:
          - system: aarch64-darwin
            runner: macos-15
          - system: x86_64-darwin
            runner: macos-15-intel
          - system: aarch64-linux
            runner: ubuntu-24.04-arm
          - system: x86_64-linux
            runner: ubuntu-24.04
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@d96bc962e61b3049ce8128d03d57a1144fa96539 # main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@cec65ff6f104850203b152861d3f9e5f1747885d # main

      - name: Sync OpenCode asset hashes
        run: ./.github/scripts/update-opencode-assets.sh

      - name: Run OpenCode build/bin checks
        run: ./.github/scripts/run-opencode-checks.sh "${{ matrix.system }}" result.json

      - name: Upload system result
        uses: actions/upload-artifact@v7
        with:
          name: route-result-${{ matrix.system }}
          path: result.json
          retention-days: 1

  reconcile:
    needs: build-matrix
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@d96bc962e61b3049ce8128d03d57a1144fa96539 # main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@cec65ff6f104850203b152861d3f9e5f1747885d # main

      - name: Sync OpenCode asset hashes
        run: ./.github/scripts/update-opencode-assets.sh

      - name: Download matrix results
        uses: actions/download-artifact@v8
        with:
          path: artifacts
          pattern: route-result-*

      - name: Normalize matrix artifacts
        run: |
          mkdir -p route-results
          for result_dir in artifacts/route-result-*; do
            if [[ -d "$result_dir" ]]; then
              system_name="${result_dir##*route-result-}"
              cp "$result_dir/result.json" "route-results/${system_name}.json"
            fi
          done

      - name: Compute routing decisions
        id: routing
        run: |
          unresolved="$(./.github/scripts/compute-opencode-routing.sh route-results packages/opencode/routing.json)"
          echo "unresolved=${unresolved}" >> "$GITHUB_OUTPUT"
          echo "Unresolved targets: ${unresolved}"

      - name: Fail when no viable route exists
        if: steps.routing.outputs.unresolved != '0'
        run: |
          echo "::error::One or more system/target pairs had neither build nor bin available."
          exit 1

      - name: Detect routing changes
        id: changes
        run: |
          if [[ -n "$(git status --porcelain packages/opencode/assets.json packages/opencode/routing.json)" ]]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create reconciliation pull request
        id: cpr
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@22a9089034f40e5a961c8808d113e2c98fb63676 # v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: automation/opencode-routing-reconcile
          delete-branch: true
          title: "chore: reconcile opencode routing"
          commit-message: "chore: reconcile opencode routing"
          body: |
            Automated OpenCode route reconciliation.

            This PR updates:
            - `packages/opencode/assets.json`
            - `packages/opencode/routing.json`

            Routing policy:
            - prefer `build` when it succeeds
            - fallback to `bin` when `build` fails and `bin` succeeds
            - preserve previous route when both fail
          add-paths: |
            packages/opencode/assets.json
            packages/opencode/routing.json

      - name: Enable pull request automerge
        if: steps.cpr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@a660677d5469627102a1c1e11409dd063606628d # v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
