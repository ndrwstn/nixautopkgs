name: Update surya hashes on Renovate PRs

on:
  pull_request:
    branches: [master]
    paths:
      - "packages/surya/default.nix"
      - ".github/scripts/update-surya-hashes.sh"
      - ".github/workflows/surya-hash-update.yml"

concurrency:
  group: surya-hash-update-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  update-surya-hashes:
    if: startsWith(github.head_ref, 'update/') && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      checks: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@d96bc962e61b3049ce8128d03d57a1144fa96539 # main

      - name: Assert Renovate branch context
        run: |
          echo "head_ref=${GITHUB_HEAD_REF}"
          echo "head_repo=${{ github.event.pull_request.head.repo.full_name }}"
          echo "base_repo=${{ github.repository }}"
          [[ "${GITHUB_HEAD_REF}" == update/* ]]
          [[ "${{ github.event.pull_request.head.repo.full_name }}" == "${{ github.repository }}" ]]

      - name: Update surya hashes
        run: ./.github/scripts/update-surya-hashes.sh

      - name: Build surya package
        run: nix build .#surya

      - name: Commit and push changes
        id: commit-push
        run: |
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No hash changes detected"
            echo "new_sha=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/surya/default.nix
          git commit -m "chore: update surya hashes"
          git push
          echo "new_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Report check status
        if: always()
        uses: LouisBrunner/checks-action@6b626ffbad7cc56fd58627f774b9067e6118af23 # v2.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: update-hashes
          sha: ${{ steps.commit-push.outputs.new_sha != '' && steps.commit-push.outputs.new_sha || github.event.pull_request.head.sha }}
          conclusion: ${{ job.status == 'success' && 'success' || 'failure' }}
