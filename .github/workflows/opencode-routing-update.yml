name: Update OpenCode Routing on Renovate PRs

on:
  pull_request:
    branches: [master]
    paths:
      - "flake.nix"
      - "packages/opencode-assets.json"
      - "packages/opencode-routing.json"
      - "packages/opencode-bin.nix"
      - ".github/scripts/*.sh"
      - ".github/workflows/opencode-routing-update.yml"

concurrency:
  group: opencode-routing-pr-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build-matrix:
    if: startsWith(github.head_ref, 'update/') && contains(github.head_ref, 'anomalyco-opencode')
    strategy:
      fail-fast: false
      matrix:
        include:
          - system: aarch64-darwin
            runner: macos-15
          - system: x86_64-darwin
            runner: macos-15-intel
          - system: aarch64-linux
            runner: ubuntu-24.04-arm
          - system: x86_64-linux
            runner: ubuntu-24.04
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Sync OpenCode lock and asset hashes
        run: ./.github/scripts/update-opencode-assets.sh --update-lock

      - name: Run OpenCode build/bin checks
        run: ./.github/scripts/run-opencode-checks.sh "${{ matrix.system }}" result.json

      - name: Upload system result
        uses: actions/upload-artifact@v4
        with:
          name: route-result-${{ matrix.system }}
          path: result.json
          retention-days: 1

  aggregate-and-commit:
    if: startsWith(github.head_ref, 'update/') && contains(github.head_ref, 'anomalyco-opencode')
    needs: build-matrix
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Sync OpenCode lock and asset hashes
        run: ./.github/scripts/update-opencode-assets.sh --update-lock

      - name: Download matrix results
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: route-result-*

      - name: Normalize matrix artifacts
        run: |
          mkdir -p route-results
          for result_dir in artifacts/route-result-*; do
            if [[ -d "$result_dir" ]]; then
              system_name="${result_dir##*route-result-}"
              cp "$result_dir/result.json" "route-results/${system_name}.json"
            fi
          done

      - name: Compute routing decisions
        id: routing
        run: |
          unresolved="$(./.github/scripts/compute-opencode-routing.sh route-results packages/opencode-routing.json)"
          echo "unresolved=${unresolved}" >> "$GITHUB_OUTPUT"
          echo "Unresolved targets: ${unresolved}"

      - name: Commit and push updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add flake.lock packages/opencode-assets.json packages/opencode-routing.json

          if git diff --cached --quiet; then
            echo "No OpenCode changes to commit"
            exit 0
          fi

          git commit -m "chore: update opencode assets and routing"
          git push

      - name: Fail when no viable route exists
        if: steps.routing.outputs.unresolved != '0'
        run: |
          echo "::error::One or more system/target pairs had neither build nor bin available."
          exit 1
